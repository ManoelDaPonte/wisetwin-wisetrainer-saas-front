# API v1 Documentation

## üèóÔ∏è Architecture

Cette API suit les principes RESTful et est organis√©e par ressources. Chaque ressource repr√©sente une entit√© m√©tier de l'application.

### Structure des dossiers

```
app/api/v1/
‚îú‚îÄ‚îÄ auth/                    # Authentification et initialisation
‚îú‚îÄ‚îÄ users/                   # Gestion des utilisateurs
‚îú‚îÄ‚îÄ organizations/           # Gestion des organisations
‚îú‚îÄ‚îÄ courses/                 # Gestion des formations
‚îú‚îÄ‚îÄ storage/                 # Acc√®s au stockage Azure
‚îî‚îÄ‚îÄ sessions/               # Tracking des sessions utilisateur
```

### Principes de conception

1. **RESTful** : Utilisation correcte des verbes HTTP (GET, POST, PATCH, DELETE)
2. **Authentification** : Toutes les routes sont prot√©g√©es par Auth0 (sauf indication contraire)
3. **Permissions** : V√©rification des droits selon le contexte (personnel/organisation)
4. **R√©ponses uniformes** : Format JSON standardis√© pour toutes les r√©ponses

### Format des r√©ponses

#### Succ√®s
```json
{
  "data": { ... },
  "meta": { ... },
  "message": "Success message"
}
```

#### Erreur
```json
{
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": { ... }
}
```

---

## üîê Authentification (`/auth`)

### `POST /api/v1/auth/initialize`
Initialise un nouvel utilisateur apr√®s sa premi√®re connexion Auth0.

**Body:** Aucun (utilise la session Auth0)

**Response:**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "azureContainer": "user-john-doe-abc123",
    "organizations": []
  }
}
```

**Logique:**
- V√©rifie si l'utilisateur existe en DB
- Cr√©e un container Azure personnel
- Initialise le profil utilisateur

---

## üë§ Utilisateurs (`/users`)

### `GET /api/v1/users/me`
R√©cup√®re le profil de l'utilisateur connect√©.

**Response:**
```json
{
  "data": {
    "id": "user-uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "azureContainer": "user-container-name",
    "createdAt": "2024-01-01T00:00:00Z",
    "organizations": [
      {
        "id": "org-uuid",
        "name": "ACME Corp",
        "role": "ADMIN"
      }
    ]
  }
}
```

### `PATCH /api/v1/users/me`
Met √† jour le profil de l'utilisateur connect√©.

**Body:**
```json
{
  "name": "Jane Doe"
}
```

**Champs modifiables:** `name`

### `DELETE /api/v1/users/me`
Supprime compl√®tement le compte utilisateur.

**Actions effectu√©es:**
- Suppression du container Azure
- Suppression de toutes les donn√©es DB
- Suppression du compte Auth0

### `GET /api/v1/users/me/stats`
R√©cup√®re les statistiques de formation de l'utilisateur.

**Response:**
```json
{
  "data": {
    "totalCourses": 12,
    "completedCourses": 8,
    "completionRate": 66,
    "totalTimeSpent": 3600,
    "averageScore": 85,
    "questionsAnswered": 150,
    "correctAnswers": 127,
    "successRate": 85
  }
}
```

### `GET /api/v1/users/me/courses`
Liste toutes les formations de l'utilisateur.

**Query params:**
- `status`: `in_progress`, `completed`, `failed`
- `organizationId`: Filtrer par organisation
- `limit`: Nombre de r√©sultats (d√©faut: 20)
- `offset`: Pagination

**Response:**
```json
{
  "data": [
    {
      "id": "safety-training",
      "name": "Formation S√©curit√©",
      "progress": 75,
      "status": "in_progress",
      "lastAccessed": "2024-01-15T10:00:00Z",
      "source": {
        "type": "organization",
        "organizationId": "org-uuid",
        "name": "ACME Corp"
      }
    }
  ],
  "meta": {
    "total": 25,
    "limit": 20,
    "offset": 0
  }
}
```

### `GET /api/v1/users/me/organizations`
Liste les organisations de l'utilisateur.

**Response:**
```json
{
  "data": [
    {
      "id": "org-uuid",
      "name": "ACME Corp",
      "role": "ADMIN",
      "joinedAt": "2024-01-01T00:00:00Z",
      "membersCount": 45
    }
  ]
}
```

### `GET /api/v1/users/[userId]/*`
M√™mes endpoints que `/me` mais pour un utilisateur sp√©cifique.
**Permissions:** Admin organisation ou propri√©taire du compte

---

## üè¢ Organisations (`/organizations`)

### `GET /api/v1/organizations`
Liste toutes les organisations de l'utilisateur connect√©.

### `POST /api/v1/organizations`
Cr√©e une nouvelle organisation.

**Body:**
```json
{
  "name": "Ma Soci√©t√©",
  "description": "Description de l'organisation",
  "logoUrl": "https://..."
}
```

**Actions:**
- Cr√©e l'organisation
- Cr√©e un container Azure d√©di√©
- Ajoute le cr√©ateur comme OWNER

### `GET /api/v1/organizations/[orgId]`
R√©cup√®re les d√©tails d'une organisation.

**Response:**
```json
{
  "data": {
    "id": "org-uuid",
    "name": "ACME Corp",
    "description": "...",
    "azureContainer": "org-acme-corp-xyz",
    "userRole": "ADMIN",
    "membersCount": 45,
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

### `PATCH /api/v1/organizations/[orgId]`
Met √† jour les informations de l'organisation.

**Permissions:** OWNER ou ADMIN

**Body:**
```json
{
  "name": "Nouveau nom",
  "description": "Nouvelle description",
  "logoUrl": "https://..."
}
```

### `DELETE /api/v1/organizations/[orgId]`
Supprime l'organisation et toutes ses donn√©es.

**Permissions:** OWNER uniquement

### Membres (`/organizations/[orgId]/members`)

#### `GET /api/v1/organizations/[orgId]/members`
Liste tous les membres de l'organisation.

**Response:**
```json
{
  "data": [
    {
      "id": "member-uuid",
      "userId": "user-uuid",
      "name": "John Doe",
      "email": "john@example.com",
      "role": "MEMBER",
      "joinedAt": "2024-01-01T00:00:00Z",
      "tags": ["Manager", "S√©curit√©"]
    }
  ]
}
```

#### `POST /api/v1/organizations/[orgId]/members`
Ajoute un membre √† l'organisation (par invitation).

**Permissions:** OWNER ou ADMIN

**Body:**
```json
{
  "email": "newuser@example.com",
  "role": "MEMBER"
}
```

**R√¥les disponibles:** `MEMBER`, `ADMIN`

#### `PATCH /api/v1/organizations/[orgId]/members/[memberId]`
Modifie le r√¥le d'un membre.

**Permissions:** 
- OWNER peut modifier tous les r√¥les
- ADMIN peut modifier MEMBER uniquement

#### `DELETE /api/v1/organizations/[orgId]/members/[memberId]`
Retire un membre de l'organisation.

### Invitations (`/organizations/[orgId]/invitations`)

#### `GET /api/v1/organizations/[orgId]/invitations`
Liste toutes les invitations en attente.

**Permissions:** OWNER ou ADMIN

#### `POST /api/v1/organizations/[orgId]/invitations`
Cr√©e une nouvelle invitation.

**Body:**
```json
{
  "email": "invite@example.com",
  "role": "MEMBER",
  "message": "Bienvenue dans notre √©quipe!"
}
```

#### `DELETE /api/v1/organizations/[orgId]/invitations/[invitationId]`
Annule une invitation.

#### `POST /api/v1/organizations/[orgId]/invitations/[invitationId]/resend`
Renvoie l'email d'invitation.

### Tags (`/organizations/[orgId]/tags`)

#### `GET /api/v1/organizations/[orgId]/tags`
Liste tous les tags de l'organisation.

**Response:**
```json
{
  "data": [
    {
      "id": "tag-uuid",
      "name": "S√©curit√©",
      "color": "#FF5733",
      "description": "Personnel de s√©curit√©",
      "userCount": 12,
      "trainingCount": 5
    }
  ]
}
```

#### `POST /api/v1/organizations/[orgId]/tags`
Cr√©e un nouveau tag.

**Permissions:** OWNER ou ADMIN

**Body:**
```json
{
  "name": "Manager",
  "color": "#3B82F6",
  "description": "Managers d'√©quipe"
}
```

#### `PATCH /api/v1/organizations/[orgId]/tags/[tagId]`
Modifie un tag existant.

#### `DELETE /api/v1/organizations/[orgId]/tags/[tagId]`
Supprime un tag et toutes ses associations.

### Formations organisation (`/organizations/[orgId]/courses`)

#### `GET /api/v1/organizations/[orgId]/courses`
Liste toutes les formations disponibles dans l'organisation.

**Query params:**
- `type`: `wisetrainer`, `wisetwin`
- `tagId`: Filtrer par tag

**Response:**
```json
{
  "data": [
    {
      "id": "safety-training",
      "name": "Formation S√©curit√©",
      "type": "wisetrainer",
      "description": "...",
      "tags": ["Obligatoire", "S√©curit√©"],
      "enrolledCount": 35
    }
  ]
}
```

---

## üìö Formations (`/courses`)

### `GET /api/v1/courses`
Liste toutes les formations disponibles.

**Query params:**
- `organizationId`: Formations d'une organisation
- `type`: `personal`, `organization`, `all`
- `search`: Recherche par nom

### `GET /api/v1/courses/[courseId]`
R√©cup√®re les d√©tails d'un cours.

**Query params:**
- `organizationId`: Contexte organisation (si applicable)

**Response:**
```json
{
  "data": {
    "id": "safety-training",
    "name": "Formation S√©curit√©",
    "description": "...",
    "modules": [
      {
        "id": "module-1",
        "title": "Introduction",
        "description": "...",
        "order": 1
      }
    ],
    "duration": "2h",
    "difficulty": "D√©butant"
  }
}
```

### `POST /api/v1/courses/[courseId]/enroll`
S'inscrit √† un cours.

**Body:**
```json
{
  "organizationId": "org-uuid"  // Optionnel
}
```

### `DELETE /api/v1/courses/[courseId]/enroll`
Se d√©sinscrit d'un cours.

### `GET /api/v1/courses/[courseId]/progress`
R√©cup√®re la progression dans un cours.

**Response:**
```json
{
  "data": {
    "courseId": "safety-training",
    "progress": 75,
    "completedModules": ["module-1", "module-2"],
    "currentModule": "module-3",
    "lastAccessed": "2024-01-15T10:00:00Z"
  }
}
```

### `PATCH /api/v1/courses/[courseId]/progress`
Met √† jour la progression.

**Body:**
```json
{
  "moduleId": "module-3",
  "completed": true,
  "score": 85
}
```

### Sc√©narios (`/courses/[courseId]/scenarios`)

#### `GET /api/v1/courses/[courseId]/scenarios/[scenarioId]`
R√©cup√®re un sc√©nario de formation.

**Response:**
```json
{
  "data": {
    "id": "scenario-1",
    "title": "√âvaluation s√©curit√©",
    "type": "questionnaire",
    "questions": [
      {
        "id": "q1",
        "text": "Quelle est la proc√©dure en cas d'incendie?",
        "type": "SINGLE",
        "options": [
          { "id": "opt1", "text": "Appeler les pompiers" },
          { "id": "opt2", "text": "√âvacuer imm√©diatement" }
        ]
      }
    ]
  }
}
```

#### `POST /api/v1/courses/[courseId]/scenarios/[scenarioId]/submit`
Soumet les r√©ponses d'un sc√©nario.

**Body:**
```json
{
  "responses": [
    {
      "questionId": "q1",
      "selectedAnswers": ["opt2"]
    }
  ]
}
```

**Response:**
```json
{
  "data": {
    "score": 85,
    "passed": true,
    "correctAnswers": 17,
    "totalQuestions": 20,
    "feedback": [
      {
        "questionId": "q1",
        "isCorrect": true,
        "explanation": "..."
      }
    ]
  }
}
```

---

## üíæ Stockage (`/storage`)

### Containers (`/storage/containers`)

#### `GET /api/v1/storage/containers/[containerName]`
Liste les blobs d'un container.

**Query params:**
- `prefix`: Pr√©fixe pour filtrer
- `maxResults`: Limite de r√©sultats

**Permissions:** Propri√©taire du container ou membre de l'organisation

#### `POST /api/v1/storage/containers/[containerName]`
Cr√©e un nouveau container.

**Permissions:** Admin syst√®me uniquement

### Blobs (`/storage/containers/[containerName]/blobs`)

#### `GET /api/v1/storage/containers/[containerName]/blobs/[...path]`
T√©l√©charge un blob.

**Headers de r√©ponse:**
- `Content-Type`: Type MIME du fichier
- `Content-Length`: Taille du fichier
- `Content-Encoding`: `gzip` si compress√©

#### `POST /api/v1/storage/containers/[containerName]/blobs/[...path]`
Upload un nouveau blob.

**Headers requis:**
- `Content-Type`: Type MIME du fichier

**Permissions:** Propri√©taire du container ou admin organisation

#### `DELETE /api/v1/storage/containers/[containerName]/blobs/[...path]`
Supprime un blob.

**Permissions:** Propri√©taire du container ou admin organisation

### Builds Unity (`/storage/builds`)

#### `GET /api/v1/storage/builds`
Recherche des builds Unity dans les containers.

**Query params:**
- `container`: Container √† scanner
- `type`: `wisetrainer`, `wisetwin`
- `organizationId`: Builds d'une organisation

**Response:**
```json
{
  "data": [
    {
      "id": "safety-training",
      "type": "wisetrainer",
      "container": "org-acme-corp",
      "files": {
        "loader": "wisetrainer/safety-training.loader.js",
        "data": "wisetrainer/safety-training.data.gz",
        "framework": "wisetrainer/safety-training.framework.js.gz",
        "wasm": "wisetrainer/safety-training.wasm.gz"
      }
    }
  ]
}
```

---

## üìä Sessions (`/sessions`)

### `POST /api/v1/sessions`
D√©marre une nouvelle session de formation.

**Body:**
```json
{
  "courseId": "safety-training",
  "organizationId": "org-uuid"  // Optionnel
}
```

**Response:**
```json
{
  "data": {
    "sessionId": "session-uuid",
    "startTime": "2024-01-15T10:00:00Z"
  }
}
```

### `PATCH /api/v1/sessions/[sessionId]`
Met √† jour une session (fin, pause, etc.).

**Body:**
```json
{
  "action": "end",
  "modulesViewed": ["module-1", "module-2"],
  "timeSpent": 3600
}
```

### `POST /api/v1/sessions/end`
Endpoint sp√©cial pour terminer une session via `sendBeacon`.

**Body:**
```json
{
  "sessionId": "session-uuid",
  "modulesViewed": ["module-1", "module-2"]
}
```

---

## üîß Codes d'erreur

| Code | Description |
|------|-------------|
| `AUTH_REQUIRED` | Authentification requise |
| `AUTH_FAILED` | √âchec d'authentification |
| `USER_NOT_FOUND` | Utilisateur non trouv√© |
| `FORBIDDEN` | Acc√®s refus√© (permissions) |
| `NOT_FOUND` | Ressource non trouv√©e |
| `VALIDATION_ERROR` | Donn√©es invalides |
| `CONFLICT` | Conflit (ex: email d√©j√† utilis√©) |
| `RATE_LIMIT` | Limite de requ√™tes atteinte |
| `SERVER_ERROR` | Erreur serveur interne |

---

## üöÄ Exemples d'utilisation

### Inscription et d√©marrage d'une formation

```javascript
// 1. S'inscrire √† un cours
const enrollment = await fetch('/api/v1/courses/safety-training/enroll', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ organizationId: 'org-123' })
});

// 2. D√©marrer une session
const session = await fetch('/api/v1/sessions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    courseId: 'safety-training',
    organizationId: 'org-123'
  })
});

// 3. R√©cup√©rer un sc√©nario
const scenario = await fetch('/api/v1/courses/safety-training/scenarios/module-1');

// 4. Soumettre les r√©ponses
const result = await fetch('/api/v1/courses/safety-training/scenarios/module-1/submit', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    responses: [
      { questionId: 'q1', selectedAnswers: ['opt2'] }
    ]
  })
});

// 5. Terminer la session
navigator.sendBeacon('/api/v1/sessions/end', JSON.stringify({
  sessionId: 'session-123',
  modulesViewed: ['module-1']
}));
```

### Gestion d'une organisation

```javascript
// 1. Cr√©er une organisation
const org = await fetch('/api/v1/organizations', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'Ma Soci√©t√©',
    description: 'Formation professionnelle'
  })
});

// 2. Inviter un membre
await fetch(`/api/v1/organizations/${orgId}/invitations`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'colleague@company.com',
    role: 'MEMBER'
  })
});

// 3. Cr√©er un tag
await fetch(`/api/v1/organizations/${orgId}/tags`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: '√âquipe S√©curit√©',
    color: '#FF5733'
  })
});

// 4. Associer le tag √† des formations
await fetch(`/api/v1/organizations/${orgId}/tags/${tagId}/courses`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    courseIds: ['safety-training', 'first-aid']
  })
});
```

---

## üìù Notes importantes

1. **Authentification** : Toutes les routes n√©cessitent une session Auth0 valide (sauf `/auth/initialize`)
2. **Permissions** : Les actions sur les organisations respectent la hi√©rarchie OWNER > ADMIN > MEMBER
3. **Contexte** : Beaucoup d'endpoints s'adaptent au contexte (personnel vs organisation)
4. **Cache** : Les r√©ponses incluent des headers de cache appropri√©s
5. **Pagination** : Les listes supportent `limit` et `offset` pour la pagination
6. **Recherche** : La plupart des listes supportent un param√®tre `search`

---

## üîó Liens utiles

- [Documentation Auth0](https://auth0.com/docs)
- [Azure Blob Storage](https://docs.microsoft.com/azure/storage/blobs/)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)